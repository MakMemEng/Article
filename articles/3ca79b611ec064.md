---
title: "LLMに独自に定義したEnumを使用して回答させたい"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
published_at: 2024-10-04 23:43
---

LLMに独自に定義したEnumから回答を選択して欲しい場合

```python
class FruitsEnum(Enum):
    Apple = "りんご"
    Banana = "ばなな"
    Peach = "もも"
    other = "その他"

class SelectedDetailsSchema(BaseModel):
    """選択した内容を確認するためのSchema."""

    selected_fruits: FruitsEnum = Field(..., description="果物を選択してください")
```

StateにFruitsEnumの値を保持させておき、分岐グラフのルーティングに使用する(後述)

```python
class State(TyepDict):
    messages: Annotated[list[AnyMessage], add_messages]
    user_info: dict
    fruits: FruitsEnum | None = None
```

```python
def ask_fruits(state: State) -> FruitsEnum:
    """選択した果物が以下のどれに該当するかを判定する
    - りんご
    - ばなな
    - もも
    - その他
    """
    messages = state["messages"]

    parser = PydanticOutputParser(pydantic_object=SelectedDetailsSchema)
    prompt = ChatPromptTemplate(
        messages=[
            HumanMessagePromptTemplate.from_template(
                "{messages}に含まれるメッセージを確認し、選択した果物が以下のどれに該当するかを判定してください"
                "- りんご"
                "- ばなな"
                "- もも"
                "- その他"
                '`"fruits": 判定結果, "reason": 判定理由`のJSON形式で返してください。'
            ),
        ],
        input_variables=["messages",],
        partial_variables={"format_instructions": parser.get_format_instructions()}
    )

    result = (prompt | model | parser).invoke({"messages": messages})
    state["fruits"] = result.fruits.value
    return result

```

`state["fruits"]`の値を見て、特定のNodeにルーティングさせる

```python
def get_state(state: State) -> Literal["continue", "ask_fruits", "red", "yellow", "pink", "end"]:
    """Determine the next state based on the last message in the agent state."""
    messages = state["messages"]
    fruits = state["fruits"]

    if not fruits:
        return "ask_fruits"

    elif not isinstance(messages[-1], HumanMessage):
        return "end"
    match fruits:
        case "りんご":
            return "red"
        case "ばなな":
            return "yellow"
        case "もも":
            return "pink"
        case "その他":
            return "end"
        case _:
            return "continue"
```

### 参考

<https://sogo.dev/posts/2024/01/langchain-agent-tools-function-calling>

### Memo

TODO: ToolMessage, AIMessageから現状の状態を取得
一問一答形式の関係上、AIMessage出力 -> HumanMessage入力受付としたいため、ToolMessageが受け取れない

TODO:  回答の型チェック
